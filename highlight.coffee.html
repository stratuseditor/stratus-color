<html>
  <head>
    <title>src/highlight.coffee - Stratus:Color</title>
    <style>
      .stratus-color {
        position: fixed;
        top: 0px;
        left: 0px;
        right: 0px;
        bottom: 0px; }
      * {
  margin: 0px;
  padding: 0px;
}
.stratus-color {
  font-family: monospace;
  font-size: 13px;
  overflow: auto;
  white-space: pre;
  word-wrap: normal;
}
.stratus-color > ul {
  float: left;
  list-style: none;
}
.stratus-color > ul li {
  height: 15px;
  padding-left: 2px;
}
.stratus-color > .stratus-color-gutter {
  float: left;
  padding: 0px 3px 0px 6px;
  text-align: right;
  -webkit-user-select: none;
}
.stratus-color > .stratus-color-gutter > span {
  display: block;
}
.stratus-color::-webkit-scrollbar {
  height: 10px;
  width: 10px;
}
.stratus-color::-webkit-scrollbar-track {
  background: #eee;
  box-shadow: inset 1px 1px 2px rgba(0,0,0,0.20);
}
.stratus-color::-webkit-scrollbar-thumb {
  background: #888;
  box-shadow: inset 1px 0px 2px rgba(0,0,0,0.20);
}
.stratus-color::-webkit-scrollbar-thumb:hover {
  background: #666;
  box-shadow: inset 1px 1px 3px rgba(0,0,0,0.20);
}

        .stratus-color {
    background: #323232;color: white; }
  
  .stratus-color *::selection {
    background: rgba(90, 100, 126, 0.35); }
  .stratus-color li::selection {
    background: rgba(90, 100, 126, 0.35); }

  .hi-search    { background: rgba(255, 255, 255, 0.4); }
  .hi-emphasize { background: rgba(255, 255, 255, 0.08);border: 1px solid rgba(255, 255, 255, 0.35);margin-left: -1px;margin-top: -1px; }
  
  .stratus-color-gutter {
    background: #f4f4f4;color: #888; }
  .stratus-color-gutter > span.current-middle {
    background: #fff;border-color: #ccc; }
  .stratus-color-gutter > span.current-top {
    border-width: 1px 0px 0px;
    border-style: solid;
    margin:       -1px 0px 0px;
    background: #fff;border-color: #ccc; }
  .stratus-color-gutter > span.current-bottom {
    border-width: 0px 0px 1px;
    border-style: solid;
    margin:       0px 0px -1px;
    background: #fff;border-color: #ccc; }
  .stratus-color-gutter > span.current {
    border-width: 1px 0px;
    border-style: solid;
    margin:       -1px 0px;
    background: #fff;border-color: #ccc; }.hi-comment { color: #bc9458;font-style: italic; }
.hi-constant { color: #b7dff8; }
.hi-constant-builtin { color: #6c99bb; }
.hi-constant-numeric { color: #6c99bb; }
.hi-constant-character { color: #a5c261; }
.hi-constant-symbol { color: #6c99bb; }
.hi-entity { color: #ffc66d; }
.hi-entity-builtin { color: #da4939; }
.hi-entity-class { color: #ffc66d; }
.hi-entity-function { color: #ffc66d; }
.hi-entity-tag { color: #ffc66d; }
.hi-entity-tag-class { color: #6c99bb; }
.hi-entity-tag-id { color: #d0cffe; }
.hi-entity-tag-attribute { color: #ffc66d; }
.hi-entity-type { color: #b7dff8; }
.hi-invalid { border-bottom: 1px solid #da4939; }
.hi-keyword { color: #cc7833; }
.hi-keyword-operator { color: #cc7833; }
.hi-markup-bold { font-weight: bold; }
.hi-markup-code {  }
.hi-markup-header { color: #b7dff8; }
.hi-markup-italic { font-style: italic; }
.hi-markup-link { text-decoration: underline; }
.hi-markup-list { color: #ffc66d; }
.hi-markup-underline { text-decoration: underline; }
.hi-string { color: #a5c261; }
.hi-string-escape { color: #aaaaaa; }
.hi-string-interpol { color: #aaaaaa;background: #202020; }
.hi-string-regexp { color: #cccc33; }
.hi-support { color: #da4939; }
.hi-support-class { color: #da4939; }
.hi-support-constant { color: #da4939; }
.hi-support-function { color: #da4939; }
.hi-support-type { color: #da4939; }
.hi-variable { color: #b7dff8; }
.hi-variable-instance { color: #d0cffe; }

    </style>
  </head>
  <body><div class='stratus-color'><div class='stratus-color-gutter'><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span><span>11</span><span>12</span><span>13</span><span>14</span><span>15</span><span>16</span><span>17</span><span>18</span><span>19</span><span>20</span><span>21</span><span>22</span><span>23</span><span>24</span><span>25</span><span>26</span><span>27</span><span>28</span><span>29</span><span>30</span><span>31</span><span>32</span><span>33</span><span>34</span><span>35</span><span>36</span><span>37</span><span>38</span><span>39</span><span>40</span><span>41</span><span>42</span><span>43</span><span>44</span><span>45</span><span>46</span><span>47</span><span>48</span><span>49</span><span>50</span><span>51</span><span>52</span><span>53</span><span>54</span><span>55</span><span>56</span><span>57</span><span>58</span><span>59</span><span>60</span><span>61</span><span>62</span><span>63</span><span>64</span><span>65</span><span>66</span><span>67</span><span>68</span><span>69</span><span>70</span><span>71</span><span>72</span><span>73</span><span>74</span><span>75</span><span>76</span><span>77</span><span>78</span><span>79</span><span>80</span><span>81</span><span>82</span><span>83</span><span>84</span><span>85</span><span>86</span><span>87</span><span>88</span><span>89</span><span>90</span><span>91</span><span>92</span><span>93</span><span>94</span><span>95</span><span>96</span><span>97</span><span>98</span><span>99</span><span>100</span><span>101</span><span>102</span><span>103</span><span>104</span><span>105</span><span>106</span><span>107</span><span>108</span><span>109</span><span>110</span><span>111</span><span>112</span><span>113</span><span>114</span><span>115</span><span>116</span><span>117</span><span>118</span><span>119</span><span>120</span><span>121</span><span>122</span><span>123</span><span>124</span><span>125</span><span>126</span><span>127</span><span>128</span><span>129</span><span>130</span><span>131</span><span>132</span><span>133</span><span>134</span><span>135</span><span>136</span><span>137</span><span>138</span><span>139</span><span>140</span><span>141</span><span>142</span><span>143</span><span>144</span><span>145</span><span>146</span><span>147</span><span>148</span><span>149</span><span>150</span><span>151</span><span>152</span><span>153</span><span>154</span><span>155</span><span>156</span><span>157</span><span>158</span><span>159</span><span>160</span><span>161</span><span>162</span><span>163</span><span>164</span><span>165</span><span>166</span><span>167</span><span>168</span><span>169</span><span>170</span><span>171</span><span>172</span><span>173</span><span>174</span><span>175</span><span>176</span><span>177</span><span>178</span><span>179</span><span>180</span><span>181</span><span>182</span><span>183</span><span>184</span><span>185</span><span>186</span><span>187</span><span>188</span><span>189</span><span>190</span><span>191</span><span>192</span><span>193</span><span>194</span><span>195</span><span>196</span><span>197</span><span>198</span><span>199</span><span>200</span><span>201</span><span>202</span><span>203</span><span>204</span><span>205</span><span>206</span><span>207</span><span>208</span><span>209</span><span>210</span><span>211</span><span>212</span><span>213</span><span>214</span><span>215</span><span>216</span><span>217</span><span>218</span><span>219</span><span>220</span><span>221</span><span>222</span><span>223</span><span>224</span><span>225</span><span>226</span><span>227</span><span>228</span><span>229</span><span>230</span><span>231</span><span>232</span><span>233</span><span>234</span><span>235</span><span>236</span><span>237</span><span>238</span><span>239</span><span>240</span><span>241</span><span>242</span><span>243</span><span>244</span><span>245</span><span>246</span><span>247</span><span>248</span><span>249</span><span>250</span><span>251</span><span>252</span><span>253</span><span>254</span><span>255</span><span>256</span><span>257</span><span>258</span><span>259</span><span>260</span><span>261</span><span>262</span><span>263</span><span>264</span><span>265</span><span>266</span><span>267</span><span>268</span><span>269</span><span>270</span><span>271</span><span>272</span><span>273</span><span>274</span><span>275</span><span>276</span><span>277</span><span>278</span><span>279</span><span>280</span><span>281</span></div><ul><li><span class='hi-comment'>###</span></li><li></li><li><span class='hi-comment'>Note: "Token" refers to an object with properties "text" and "type".</span></li><li></li><li><span class='hi-comment'>###</span></li><li></li><li><span>html </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> require </span><span class='hi-string hi-string-literal'>'./renderers/html'</span></li><li></li><li><span class='hi-comment'># Create some tokens for the given text.</span></li><li><span class='hi-comment'># </span></li><li><span class='hi-comment'># text    - The string to be highlighted.</span></li><li><span class='hi-comment'># context - The starting context.</span></li><li><span class='hi-comment'># options - An hash. Keys:</span></li><li><span class='hi-comment'>#           * format - Default: "html", "json".</span></li><li><span class='hi-comment'>#           * gutter - Only applicable when "format" is "html".</span></li><li><span class='hi-comment'>#             Whether or not line numbers are rendered.</span></li><li><span class='hi-comment'># </span></li><li><span class='hi-comment'># Examples</span></li><li><span class='hi-comment'># </span></li><li><span class='hi-comment'>#   highlight "def foo()\n  true\nend", "Ruby"</span></li><li><span class='hi-comment'>#   # &#61;&gt; "..."</span></li><li><span class='hi-comment'># </span></li><li><span class='hi-comment'># Returns based on format:</span></li><li><span class='hi-comment'># </span></li><li><span class='hi-comment'>#   * html: html string</span></li><li><span class='hi-comment'>#   * json: list of token objects by line</span></li><li><span class='hi-comment'># </span></li><li><span class='hi-comment'># Each token has the properties `type` and `text`.</span></li><li><span>module.exports </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> highlight </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> (text, stack, options </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> {}) </span><span class='hi-keyword hi-keyword-operator'>-&gt;</span></li><li><span>  lines        </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> text.split </span><span class='hi-string hi-string-literal'>"\n"</span></li><li><span>  tokensByLine </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> []</span></li><li><span>  </span></li><li><span>  </span><span class='hi-keyword'>for</span><span> line </span><span class='hi-keyword'>in</span><span> lines</span></li><li><span>    {tokens, stack} </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> tokenize </span><span class='hi-string hi-string-literal'>"\n</span><span class='hi-string hi-string-interpol'>#{</span><span>line</span><span class='hi-string hi-string-interpol'>}</span><span class='hi-string hi-string-literal'>\n"</span><span>, stack</span></li><li><span>    tokensByLine.push tokens</span></li><li><span>  </span></li><li><span>  </span><span class='hi-keyword'>if</span><span> </span><span class='hi-keyword hi-keyword-operator'>!</span><span>options.format </span><span class='hi-keyword hi-keyword-operator'>||</span><span> options.format </span><span class='hi-keyword hi-keyword-operator'>&#61;&#61;</span><span> </span><span class='hi-string hi-string-literal'>"html"</span></li><li><span>    </span><span class='hi-keyword'>return</span><span> html tokensByLine, options</span></li><li><span>  </span><span class='hi-keyword'>else</span><span> </span><span class='hi-keyword'>if</span><span> options.format </span><span class='hi-keyword hi-keyword-operator'>&#61;&#61;</span><span> </span><span class='hi-string hi-string-literal'>"json"</span></li><li><span>    </span><span class='hi-keyword'>return</span><span> tokensByLine</span></li><li><span>  </span><span class='hi-keyword'>else</span></li><li><span>    </span><span class='hi-keyword'>throw</span><span> </span><span class='hi-keyword'>new</span><span> Error </span><span class='hi-string hi-string-literal'>"Unknown format: '</span><span class='hi-string hi-string-interpol'>#{</span><span> options.format </span><span class='hi-string hi-string-interpol'>}</span><span class='hi-string hi-string-literal'>'"</span></li><li></li><li></li><li><span class='hi-comment'># Create some tokens for the given text.</span></li><li><span class='hi-comment'># </span></li><li><span class='hi-comment'># text    - The string to be highlighted.</span></li><li><span class='hi-comment'># context - The starting context.</span></li><li><span class='hi-comment'># </span></li><li><span class='hi-comment'># Return a list of tokens.</span></li><li><span class='hi-comment'># Each token has the properties `type` and `text`.</span></li><li><span>highlight.tokenize </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> tokenize </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> (text, stack) </span><span class='hi-keyword hi-keyword-operator'>-&gt;</span></li><li><span>  stack        </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> [stack] </span><span class='hi-keyword'>if</span><span> </span><span class='hi-keyword'>typeof</span><span>(stack) </span><span class='hi-keyword hi-keyword-operator'>&#61;&#61;</span><span> </span><span class='hi-string hi-string-literal'>"string"</span></li><li><span>  tokens       </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> []</span></li><li><span>  charIndex    </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> </span><span class='hi-constant hi-constant-numeric'>0</span></li><li><span>  currentRules </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> </span><span class='hi-constant hi-constant-builtin'>null</span></li><li><span>  </span></li><li><span>  addToken </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> (token) </span><span class='hi-keyword hi-keyword-operator'>-&gt;</span></li><li><span>    </span><span class='hi-comment'># The tokens have the same type, so combine them.</span></li><li><span>    </span><span class='hi-keyword'>if</span><span> (prevToken </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> last(tokens)) </span><span class='hi-keyword'>and</span><span> prevToken.type </span><span class='hi-keyword hi-keyword-operator'>&#61;&#61;</span><span> token.type</span></li><li><span>      prevToken.text </span><span class='hi-keyword hi-keyword-operator'>+&#61;</span><span> token.text</span></li><li><span>    </span><span class='hi-keyword'>else</span></li><li><span>      tokens.push token</span></li><li><span>  </span></li><li><span>  setCurrentRules </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> </span><span class='hi-keyword hi-keyword-operator'>-&gt;</span></li><li><span>    currentRules </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> highlight.scopes[last(stack)]</span></li><li><span>  setCurrentRules()</span></li><li><span>  </span></li><li><span>  </span><span class='hi-keyword'>while</span><span> text[charIndex]</span></li><li><span>    subText  </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> text.slice charIndex</span></li><li><span>    isMatch  </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> </span><span class='hi-constant hi-constant-builtin'>false</span></li><li><span>    prevChar </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> text[charIndex </span><span class='hi-keyword hi-keyword-operator'>-</span><span> </span><span class='hi-constant hi-constant-numeric'>1</span><span>]</span></li><li><span>    </span></li><li><span>    </span><span class='hi-keyword'>for</span><span> rule </span><span class='hi-keyword'>in</span><span> currentRules</span></li><li><span>      </span><span class='hi-keyword'>if</span><span> match </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> matchOnce rule, subText, prevChar</span></li><li><span>        </span><span class='hi-comment'># A single token.</span></li><li><span>        </span><span class='hi-keyword'>if</span><span> match.token</span></li><li><span>          addToken match.token </span><span class='hi-keyword'>if</span><span> match.token.text</span></li><li><span>        </span><span class='hi-comment'># Many tokens.</span></li><li><span>        </span><span class='hi-keyword'>else</span></li><li><span>          </span><span class='hi-keyword'>for</span><span> token </span><span class='hi-keyword'>in</span><span> match.tokens</span></li><li><span>            addToken token</span></li><li><span>          </span></li><li><span>        charIndex </span><span class='hi-keyword hi-keyword-operator'>+&#61;</span><span> match.length</span></li><li><span>        </span></li><li><span>        </span><span class='hi-keyword'>if</span><span> match.next </span><span class='hi-keyword hi-keyword-operator'>&#61;&#61;</span><span> </span><span class='hi-constant hi-constant-builtin'>false</span></li><li><span>          stack.pop()</span></li><li><span>          setCurrentRules()</span></li><li><span>        </span><span class='hi-keyword'>else</span><span> </span><span class='hi-keyword'>if</span><span> match.next</span></li><li><span>          stack.push match.next</span></li><li><span>          setCurrentRules()</span></li><li><span>        </span></li><li><span>        isMatch </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> </span><span class='hi-constant hi-constant-builtin'>true</span></li><li><span>        </span><span class='hi-keyword'>break</span></li><li><span>    </span></li><li><span>    </span><span class='hi-keyword'>if</span><span> </span><span class='hi-keyword hi-keyword-operator'>!</span><span>isMatch </span><span class='hi-keyword'>and</span><span> subText[</span><span class='hi-constant hi-constant-numeric'>0</span><span>] </span><span class='hi-keyword hi-keyword-operator'>!&#61;</span><span> </span><span class='hi-string hi-string-literal'>"\n"</span></li><li><span>      addToken { </span><span class='hi-entity hi-entity-function'>type:</span><span> </span><span class='hi-string hi-string-literal'>""</span><span>, </span><span class='hi-entity hi-entity-function'>text:</span><span> subText[</span><span class='hi-constant hi-constant-numeric'>0</span><span>] }</span></li><li><span>    </span><span class='hi-keyword'>if</span><span> </span><span class='hi-keyword hi-keyword-operator'>!</span><span>isMatch</span></li><li><span>      charIndex</span><span class='hi-keyword hi-keyword-operator'>++</span></li><li><span>  </span></li><li><span>  </span><span class='hi-keyword'>return</span><span> {stack, tokens}</span></li><li></li><li><span>highlight.scopes </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> {}</span></li><li><span class='hi-keyword'>if</span><span> </span><span class='hi-keyword'>typeof</span><span>(window) </span><span class='hi-keyword hi-keyword-operator'>!&#61;</span><span> </span><span class='hi-string hi-string-literal'>"undefined"</span></li><li><span>  </span><span class='hi-keyword'>if</span><span> window.stratusColor</span><span class='hi-keyword hi-keyword-operator'>?</span><span>.scopes</span></li><li><span>    highlight.scopes </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> window.stratusColor.scopes</span></li><li><span>  </span><span class='hi-keyword'>else</span></li><li><span>    window.stratusColor </span><span class='hi-keyword hi-keyword-operator'>?&#61;</span><span> {}</span></li><li><span>    window.stratusColor.scopes </span><span class='hi-keyword hi-keyword-operator'>?&#61;</span><span> highlight.scopes</span></li><li></li><li><span>highlight.html   </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> html.tokensToHtml</span></li><li><span>highlight.escape </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> html.escape</span></li><li></li><li><span class='hi-comment'># Public: Add the syntax highlighter rules to the repo.</span></li><li><span class='hi-comment'># </span></li><li><span class='hi-comment'># scopes - An object keyed by the context name, and the value</span></li><li><span class='hi-comment'>#          is a list of rules. All but one of the keys (the</span></li><li><span class='hi-comment'>#          required one) must begin with a hash symbol.</span></li><li><span class='hi-comment'># </span></li><li><span class='hi-comment'># No return value.</span></li><li><span>highlight.addScopes </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> (scopes) </span><span class='hi-keyword hi-keyword-operator'>-&gt;</span></li><li><span>  </span><span class='hi-comment'># Find the base scope (the non-repo one).</span></li><li><span>  baseScope </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> </span><span class='hi-constant hi-constant-builtin'>null</span></li><li><span>  </span><span class='hi-keyword'>for</span><span> context, rules </span><span class='hi-keyword'>of</span><span> scopes</span></li><li><span>    </span><span class='hi-keyword'>if</span><span> context[</span><span class='hi-constant hi-constant-numeric'>0</span><span>] </span><span class='hi-keyword hi-keyword-operator'>!&#61;</span><span> </span><span class='hi-string hi-string-literal'>"#"</span></li><li><span>      baseScope </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> context</span></li><li><span>      </span><span class='hi-keyword'>break</span></li><li><span>  </span></li><li><span>  </span></li><li><span>  </span><span class='hi-comment'># Create and compile the scopes</span></li><li><span>  </span><span class='hi-keyword'>for</span><span> context, rules </span><span class='hi-keyword'>of</span><span> scopes</span></li><li><span>    </span><span class='hi-comment'># Repository: `rules` is actually a single rule.</span></li><li><span>    </span><span class='hi-keyword'>if</span><span> context[</span><span class='hi-constant hi-constant-numeric'>0</span><span>] </span><span class='hi-keyword hi-keyword-operator'>&#61;&#61;</span><span> </span><span class='hi-string hi-string-literal'>"#"</span></li><li><span>      context </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> baseScope </span><span class='hi-keyword hi-keyword-operator'>+</span><span> context</span></li><li><span>      highlight.scopes[context] </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> compileRule rules, baseScope</span></li><li><span>    </span><span class='hi-comment'># Regular</span></li><li><span>    </span><span class='hi-keyword'>else</span></li><li><span>      highlight.scopes[context] </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> </span><span class='hi-keyword'>for</span><span> subRule </span><span class='hi-keyword'>in</span><span> rules</span></li><li><span>        compileRule subRule, baseScope</span></li><li><span>  </span></li><li><span>  </span><span class='hi-keyword'>return</span></li><li></li><li><span class='hi-comment'># Public: Return whether or not a scope has been loaded with the given name.</span></li><li><span class='hi-comment'># </span></li><li><span class='hi-comment'># scope - A string such as "Ruby".</span></li><li><span class='hi-comment'># </span></li><li><span class='hi-comment'># Return boolean.</span></li><li><span>highlight.hasScope </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> (scope) </span><span class='hi-keyword hi-keyword-operator'>-&gt;</span></li><li><span>  </span><span class='hi-keyword'>return</span><span> </span><span class='hi-keyword hi-keyword-operator'>!!</span><span>highlight.scopes[scope]</span></li><li></li><li><span class='hi-comment'># </span></li><li><span class='hi-comment'># </span></li><li><span class='hi-comment'># rule     - The compiled rule to test with.</span></li><li><span class='hi-comment'># text     - The text to test.</span></li><li><span class='hi-comment'># stack    - The current scopes.</span></li><li><span class='hi-comment'># prevChar - The char in the text being highlighted just before `subText`.</span></li><li><span class='hi-comment'>#            This is used for a fake lookbehind to match keywords.</span></li><li><span class='hi-comment'># </span></li><li><span class='hi-comment'># Return an object with properties:</span></li><li><span class='hi-comment'># * token or tokens - A single token (or a list of tokens).</span></li><li><span class='hi-comment'># * next   - The scope that was entered. This should be pushed</span></li><li><span class='hi-comment'>#            onto the stack.</span></li><li><span class='hi-comment'># * length -  The match length.</span></li><li><span>highlight.matchOnce </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> matchOnce </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> (rule, text, prevChar) </span><span class='hi-keyword hi-keyword-operator'>-&gt;</span></li><li><span>  </span><span class='hi-comment'># Catch all</span></li><li><span>  </span><span class='hi-keyword'>if</span><span> rule.isCatchAll </span><span class='hi-keyword hi-keyword-operator'>&#61;&#61;</span><span> </span><span class='hi-constant hi-constant-builtin'>true</span></li><li><span>    </span><span class='hi-keyword'>return</span><span> {</span></li><li><span>      </span><span class='hi-entity hi-entity-function'>length:</span><span> </span><span class='hi-constant hi-constant-numeric'>1</span></li><li><span>      </span><span class='hi-entity hi-entity-function'>token:</span></li><li><span>        </span><span class='hi-entity hi-entity-function'>type:</span><span> rule.token</span></li><li><span>        </span><span class='hi-entity hi-entity-function'>text:</span><span> text[</span><span class='hi-constant hi-constant-numeric'>0</span><span>].replace(</span><span class='hi-string hi-string-regexp'>/\n/g</span><span>, </span><span class='hi-string hi-string-literal'>""</span><span>)</span></li><li><span>    }</span></li><li><span>    </span></li><li><span>  </span><span class='hi-comment'># Self reference</span></li><li><span>  </span><span class='hi-keyword'>else</span><span> </span><span class='hi-keyword'>if</span><span> rule.include </span><span class='hi-keyword hi-keyword-operator'>&#61;&#61;</span><span> </span><span class='hi-string hi-string-literal'>"$self"</span></li><li><span>    </span><span class='hi-keyword'>for</span><span> subRule </span><span class='hi-keyword'>in</span><span> highlight.scopes[rule.self]</span></li><li><span>      </span><span class='hi-keyword'>return</span><span> m </span><span class='hi-keyword'>if</span><span> m </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> matchOnce subRule, text, prevChar</span></li><li><span>  </span></li><li><span>  </span><span class='hi-comment'># Language or repository include.</span></li><li><span>  </span><span class='hi-keyword'>else</span><span> </span><span class='hi-keyword'>if</span><span> </span><span class='hi-string hi-string-regexp'>/[@#]/</span><span>.test rule.include</span></li><li><span>    subRules </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> highlight.scopes[rule.include.replace(</span><span class='hi-string hi-string-regexp'>/^@/</span><span>, </span><span class='hi-string hi-string-literal'>""</span><span>)]</span></li><li><span>    </span><span class='hi-keyword'>if</span><span> subRules </span><span class='hi-keyword'>instanceof</span><span> Array</span></li><li><span>      </span><span class='hi-keyword'>for</span><span> subRule </span><span class='hi-keyword'>in</span><span> subRules</span></li><li><span>        </span><span class='hi-keyword'>return</span><span> m </span><span class='hi-keyword'>if</span><span> m </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> matchOnce subRule, text, prevChar</span></li><li><span>    </span><span class='hi-comment'># Repo: single-rule include</span></li><li><span>    </span><span class='hi-keyword'>else</span></li><li><span>      </span><span class='hi-keyword'>return</span><span> m </span><span class='hi-keyword'>if</span><span> m </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> matchOnce subRules, text, prevChar</span></li><li><span>  </span></li><li><span>  </span><span class='hi-comment'># Keyword rule.</span></li><li><span>  </span><span class='hi-keyword'>else</span><span> </span><span class='hi-keyword'>if</span><span> rule.isKeyword</span></li><li><span>    </span><span class='hi-keyword'>return</span><span> </span><span class='hi-constant hi-constant-builtin'>null</span><span> </span><span class='hi-keyword'>if</span><span> prevChar </span><span class='hi-keyword hi-keyword-operator'>&amp;&amp;</span><span> </span><span class='hi-string hi-string-regexp'>/\w/</span><span>.test prevChar</span></li><li><span>    match </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> rule.match.</span><span class='hi-support hi-support-function'>exec</span><span> text</span></li><li><span>    </span><span class='hi-keyword'>return</span><span> </span><span class='hi-constant hi-constant-builtin'>null</span><span> </span><span class='hi-keyword'>unless</span><span> match</span></li><li><span>    token </span><span class='hi-keyword hi-keyword-operator'>&#61;</span></li><li><span>      </span><span class='hi-entity hi-entity-function'>type:</span><span> rule.token</span></li><li><span>      </span><span class='hi-entity hi-entity-function'>text:</span><span> match[</span><span class='hi-constant hi-constant-numeric'>0</span><span>].replace(</span><span class='hi-string hi-string-regexp'>/\n/g</span><span>, </span><span class='hi-string hi-string-literal'>""</span><span>)</span></li><li><span>    {length} </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> match[</span><span class='hi-constant hi-constant-numeric'>0</span><span>]</span></li><li><span>    {next}   </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> rule</span></li><li><span>    </span><span class='hi-keyword'>return</span><span> {token, length, next}</span></li><li><span>    </span></li><li><span>  </span><span class='hi-comment'># Regex match.</span></li><li><span>  </span><span class='hi-keyword'>else</span><span> </span><span class='hi-keyword'>if</span><span> rule.match</span></li><li><span>    </span><span class='hi-keyword'>return</span><span> </span><span class='hi-constant hi-constant-builtin'>null</span><span> </span><span class='hi-keyword'>if</span><span> rule.behind </span><span class='hi-keyword hi-keyword-operator'>&amp;&amp;</span><span> </span><span class='hi-keyword hi-keyword-operator'>!</span><span>rule.behind.test(prevChar)</span></li><li><span>    match    </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> rule.match.</span><span class='hi-support hi-support-function'>exec</span><span> text</span></li><li><span>    </span><span class='hi-keyword'>return</span><span> </span><span class='hi-constant hi-constant-builtin'>null</span><span> </span><span class='hi-keyword'>unless</span><span> match</span></li><li><span>    {length} </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> match[</span><span class='hi-constant hi-constant-numeric'>0</span><span>]</span></li><li><span>    {next}   </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> rule</span></li><li><span>    token </span><span class='hi-keyword hi-keyword-operator'>&#61;</span></li><li><span>      </span><span class='hi-entity hi-entity-function'>type:</span><span> rule.token</span></li><li><span>      </span><span class='hi-entity hi-entity-function'>text:</span><span> match[</span><span class='hi-constant hi-constant-numeric'>0</span><span>].replace(</span><span class='hi-string hi-string-regexp'>/\n/g</span><span>, </span><span class='hi-string hi-string-literal'>""</span><span>)</span></li><li><span>    </span><span class='hi-keyword'>return</span><span> {token, length, next}</span></li><li><span>  </span></li><li><span>  </span><span class='hi-keyword'>return</span><span> </span><span class='hi-constant hi-constant-builtin'>null</span></li><li></li><li></li><li><span class='hi-comment'># Compile the pretty rule into one that can be used by the parser.</span></li><li><span class='hi-comment'># </span></li><li><span class='hi-comment'># Return an object with the following keys:</span></li><li><span class='hi-comment'># * token     - </span></li><li><span class='hi-comment'># * next      - The scope to enter after this rule is matched.</span></li><li><span class='hi-comment'># * isKeyword -</span></li><li><span class='hi-comment'># * include   - "@Language", "$self", "Language#repo", ...</span></li><li><span class='hi-comment'># * self</span></li><li><span class='hi-comment'># * isCatchAll</span></li><li><span class='hi-comment'># * behind</span></li><li><span>highlight.compileRule </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> compileRule </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> (rule, self) </span><span class='hi-keyword hi-keyword-operator'>-&gt;</span></li><li><span>  newRule </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> {</span><span class='hi-entity hi-entity-function'>token:</span><span> rule.token </span><span class='hi-keyword hi-keyword-operator'>||</span><span> </span><span class='hi-string hi-string-literal'>""</span><span>}</span></li><li><span>  </span></li><li><span>  </span><span class='hi-keyword'>if</span><span> rule.match</span></li><li><span>    newRule.match </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> </span><span class='hi-keyword'>new</span><span> RegExp </span><span class='hi-string hi-string-literal'>"^(?:</span><span class='hi-string hi-string-interpol'>#{</span><span> rule.match </span><span class='hi-string hi-string-interpol'>}</span><span class='hi-string hi-string-literal'>)"</span></li><li><span>    </span><span class='hi-keyword'>if</span><span> rule.behind</span></li><li><span>      newRule.behind </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> </span><span class='hi-keyword'>new</span><span> RegExp rule.behind</span></li><li><span>  </span><span class='hi-keyword'>else</span><span> </span><span class='hi-keyword'>if</span><span> rule.begin</span></li><li><span>    cId </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> </span><span class='hi-string hi-string-literal'>"_"</span><span> </span><span class='hi-keyword hi-keyword-operator'>+</span><span> contextId</span><span class='hi-keyword hi-keyword-operator'>++</span></li><li><span>    </span><span class='hi-comment'># The begin rule</span></li><li><span>    newRule.match </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> </span><span class='hi-keyword'>new</span><span> RegExp </span><span class='hi-string hi-string-literal'>"^(?:</span><span class='hi-string hi-string-interpol'>#{</span><span> rule.begin </span><span class='hi-string hi-string-interpol'>}</span><span class='hi-string hi-string-literal'>)"</span></li><li><span>    newRule.next  </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> cId</span></li><li><span>    </span></li><li><span>    compiledRules </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> []</span></li><li><span>    </span><span class='hi-comment'># The end rule.</span></li><li><span>    </span><span class='hi-comment'># This is first to ensure its precidence over the include.</span></li><li><span>    compiledRules.push</span></li><li><span>      </span><span class='hi-entity hi-entity-function'>token:</span><span> rule.token</span></li><li><span>      </span><span class='hi-entity hi-entity-function'>match:</span><span> </span><span class='hi-keyword'>new</span><span> RegExp </span><span class='hi-string hi-string-literal'>"^(?:</span><span class='hi-string hi-string-interpol'>#{</span><span> rule.end </span><span class='hi-string hi-string-interpol'>}</span><span class='hi-string hi-string-literal'>)"</span></li><li><span>      </span><span class='hi-entity hi-entity-function'>next:</span><span>  </span><span class='hi-constant hi-constant-builtin'>false</span><span> </span><span class='hi-comment'># false indicates that we should leave the context</span></li><li><span>    </span></li><li><span>    </span><span class='hi-comment'># Includes</span></li><li><span>    </span><span class='hi-comment'># Special include (language, repo, $self).</span></li><li><span>    </span><span class='hi-keyword'>if</span><span> rule.include </span><span class='hi-keyword'>and</span><span> </span><span class='hi-keyword'>typeof</span><span>(rule.include) </span><span class='hi-keyword hi-keyword-operator'>&#61;&#61;</span><span> </span><span class='hi-string hi-string-literal'>"string"</span></li><li><span>      </span><span class='hi-comment'># Repo</span></li><li><span>      incScope </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> rule.include</span></li><li><span>      incScope </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> self </span><span class='hi-keyword hi-keyword-operator'>+</span><span> incScope </span><span class='hi-keyword'>if</span><span> rule.include[</span><span class='hi-constant hi-constant-numeric'>0</span><span>] </span><span class='hi-keyword hi-keyword-operator'>&#61;&#61;</span><span> </span><span class='hi-string hi-string-literal'>"#"</span></li><li><span>      compiledRules.push { </span><span class='hi-entity hi-entity-function'>include:</span><span> incScope, self }</span></li><li><span>    </span><span class='hi-comment'># Rule include.</span></li><li><span>    </span><span class='hi-keyword'>else</span></li><li><span>      </span><span class='hi-keyword'>for</span><span> subRule </span><span class='hi-keyword'>in</span><span> (rule.include </span><span class='hi-keyword hi-keyword-operator'>||</span><span> [])</span></li><li><span>        compiledRules.push compileRule(subRule, self)</span></li><li><span>      </span></li><li><span>      compiledRules.push { </span><span class='hi-entity hi-entity-function'>token:</span><span> rule.token, </span><span class='hi-entity hi-entity-function'>isCatchAll:</span><span> </span><span class='hi-constant hi-constant-builtin'>true</span><span> }</span></li><li><span>    </span></li><li><span>    highlight.scopes[cId] </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> compiledRules</span></li><li><span>  </span></li><li><span>  </span><span class='hi-comment'># Include repo rule.</span></li><li><span>  </span><span class='hi-keyword'>else</span><span> </span><span class='hi-keyword'>if</span><span> rule.include</span></li><li><span>    newRule </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> { </span><span class='hi-entity hi-entity-function'>include:</span><span> self </span><span class='hi-keyword hi-keyword-operator'>+</span><span> rule.include, self }</span></li><li><span>  </span></li><li><span>  </span><span class='hi-keyword'>else</span><span> </span><span class='hi-keyword'>if</span><span> rule.keywords</span></li><li><span>    newRule.match     </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> </span><span class='hi-keyword'>new</span><span> RegExp </span><span class='hi-string hi-string-literal'>"^(?:</span><span class='hi-string hi-string-interpol'>#{</span><span> rule.keywords </span><span class='hi-string hi-string-interpol'>}</span><span class='hi-string hi-string-literal'>)(?&#61;[^\\w]|\n)"</span></li><li><span>    newRule.isKeyword </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> </span><span class='hi-constant hi-constant-builtin'>true</span></li><li><span>  </span></li><li><span>  </span><span class='hi-keyword'>return</span><span> newRule</span></li><li></li><li></li><li></li><li><span>contextId </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> </span><span class='hi-constant hi-constant-numeric'>0</span></li><li></li><li><span class='hi-comment'># Helpers</span></li><li><span>last </span><span class='hi-keyword hi-keyword-operator'>&#61;</span><span> (arr) </span><span class='hi-keyword hi-keyword-operator'>-&gt;</span><span> arr[arr.length </span><span class='hi-keyword hi-keyword-operator'>-</span><span> </span><span class='hi-constant hi-constant-numeric'>1</span><span>]</span></li><li></li><li></li><li></li></ul></div></body>
</html>